= https://jit.o3.ru/browse/MPMT-3550[Конструктор инфографики с текстом и иконками]
:toc:
:toc-title:         Содержание

== Бизнес-ценность

Текущие решения для создания маркетинговых материалов требуют использования профессиональных графических редакторов, что создает барьеры для продавцов и маркетологов.

=== Контекст

Необходимо создать интерактивный веб-инструмент для генерации изображений товаров с возможностью размещения текстовых блоков и иконок на холсте на фоне изображения.

=== Алгоритмы взаимодействия пользователя

==== Алгоритм создания текста на холсте

- Пользователь загружает изображение через кнопку "Загрузить" справа на холсте либо выбирает картинку из существующей внизу галереи
- Пользователь выбирает таб "Текст" в левой панели
- Пользователь в поле textarea вводит интересующий текст
- Пользователь кликает в нужном месте холста для размещения текстового элемента
- Текст появляется на холсте в выбранной позиции с возможностью дальнейшего редактирования
- Текст появляется на холсте с рамкой выделения
- Новый текст всегда выше по z-оси всех предыдущих элементов на холсте

==== Алгоритм создания иконки на холсте

- Пользователь загружает фоновое изображение (аналогично тексту)
- Пользователь выбирает таб "Иконки" в левой панели
- Пользователь выбирает подходящую иконку из галереи доступных иконок
- Пользователь кликает в нужном месте холста для размещения иконки
- Пользователь по желанию выбирает заливку иконки
- Иконка появляется на холсте с рамкой выделения
- Новая иконка всегда выше по z-оси всех предыдущих элементов на холсте

==== Алгоритм редактирования элемента на холсте

- Пользователь кликает на любой элемент (текст или иконку) на холсте
- Элемент выделяется с отображением границ и точек управления размером
- Для текста: двойной клик активирует режим редактирования содержимого
- Для иконки: настройки заливки и других параметров доступны в левой панели
- Изменения автоматически сохраняются в истории действий
- Изменения автоматически применяются на картинке и сохраняются в фото товара

==== Алгоритм перемещения элементов

- Пользователь кликает на элемент и удерживает кнопку мыши
- После превышения threshold начинается перетаскивание
- Элемент перемещается следом за курсором мыши
- При отпускании кнопки мыши элемент фиксируется в новой позиции
- Позиция ограничивается границами холста

==== Алгоритм изменения размера элементов

- Пользователь выделяет элемент кликом
- Появляются 8 точек управления размером по периметру элемента и рамка элемента
- Пользователь захватывает одну из точек и перетаскивает в нужном направлении
- Элемент изменяет размер рамки в реальном времени 
- Сам текст или иконка НЕ МАСШТАБИРУЕТСЯ при изменения рамки
- Размер ограничивается минимальными и максимальными значениями

==== Алгоритм удаления элементов

- Пользователь выделяет элемент кликом
- Нажимает клавишу Delete или Backspace для удаления элемента
- Система различает режим редактирования текста и удаления элемента
- При редактировании текста Delete/Backspace работают как обычные клавиши редактирования
- При выделенном элементе Delete/Backspace удаляют весь элемент с холста

==== Алгоритм работы с историей изменений

- Все действия пользователя автоматически сохраняются в истории
- Пользователь может использовать клавишу отмены для отмены последнего действия
- Пользователь может использовать клавишу повтора для отмененного действия
- Доступна навигация по истории с помощью специальных элементов управления
- Возможность вернуться к исходному состоянию холста без элементов
- В историю изменений попадает перемещение, изменение размеров рамки, появление и удалени элементов, изменение настроек элементов


=== Функциональные требования

1. **Работа с холстом**
   - Размещение элементов кликом мыши
   - Выделение и управление элементами

2. **Текстовые элементы**
   - Создание и управление текстом на холсте
   - Редактирование текста на месте
   - Система перетаскивания элементов
   - Позиционирование элементов
   - Настройка типа шрифта, размера, цвета и скругления

3. **Элементы иконок**
   - Выбор и размещение иконок на холсте
   - Настройка заливки иконки
   - Все возможности текстовых элементов для иконок

4. **Система границ**
   - Создание границ и точек управления для изменения размера
   - Обработка 8 направлений изменения размера

5. **История изменений**
   - Функционал отмены/повтора действий
   - Перемещение между изменениями
   - Просмотр исходного холста
   - Обработка типов изменений

6. **UI компоненты**
   - Левая панель с табами и настройками
   - Правая панель с preview и элементами управления
   - Контекстные меню и модальные окна

=== Критерии готовности

- Пользователь может создавать изображения, размещая текст и иконки на холсте
- Все элементы поддерживают перетаскивание, изменение размера и редактирование
- Пользователь может удалять и перемещать элементы с помощью клавиш
- Реализована полноценная система истории изменений с отменой/повтором, а также возможностью стереть историю и вернуться к исходному варианту
- Готовые изображения экспортируются в фото карточки
- Интерфейс покрыт автоматизированными тестами

== Решение

=== Архитектурные решения

**Технический стек:**
- html2canvas для экспорта готовых изображений
- использование html для размещения элементов а не canvas

=== Технические особенности

**Система управления элементами:**
Элементы холста (текст и иконки) реализованы как DOM-элементы с применением класса TextDiv и IconDiv, который инкапсулирует всю логику взаимодействия:
- Обработка событий мыши для выделения и перетаскивания
- Интеграция с системой границ для изменения размера
- Поддержка редактирования контента через contentEditable

**Система истории изменений:**
Реализуется паттерн Command для отслеживания всех изменений на холсте:
- Каждое действие пользователя сохраняется как команда
- Поддержка навигации по истории в обоих направлениях
- Классификация типов изменений для оптимизации производительности
- Возможно использование Proxy для отслеживания истории изменения объекта(прокинуть Proxy -> TextDiv и Icon)

**Обработка событий мыши:**
Используется система threshold для различения клика и начала перетаскивания, что обеспечивает точное управление элементами без случайных перемещений.

**Обработка событий клавиши:**
- Нажатие на Delete и Backspace удаляют элемент с холста

**Система позиционирования:**
Элементы позиционируются через CSS свойства left/top с планами миграции на transform для улучшения производительности при анимациях.

**Экспорт изображений:**
Использование библиотеки html2canvas для преобразования DOM-структуры холста в растровое изображение с сохранением всех визуальных эффектов и стилей.

== Риски и сложности

- Производительность при работе с большим количеством элементов - нужно понять как будет вести себя холст когда элементов их будет много и отдельно посмотреть этот кейс

== Сложные технические кейсы

- Границы холста и позиционирование - требуется уделить
особое внимание перетаскиванию, позиционированию и изменению границ элементов у границ холста
Возможные технические баги - требуется особо тестировать такие кейсы

- Разграничение режимов редактирования текста и удаления элементов(когда мы редактируем элемент и когда мы его удаляем)

- Разграничение режимов удаления элемента с холста через Backspace, Delete и когда пользователь просто стирает сам текст внутри редактируемого элемента

- Синхронизация состояния между  компонентами справа на холсте и слева - при переключении настройки должны меняться - должен ли меняться таб(текста и иконок) при переключении между текстом и иконкой

=== Дополнительные материалы

- макет https://www.figma.com/design/3tPC3e7V6UaJMHpHAcpnnJ/%D0%9C%D0%B5%D0%B4%D0%B8%D0%B0-5.0?node-id=3863-171861&t=RebhAYL1CYDhtICN-0